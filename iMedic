{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "34c789dc",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:45:04.407952Z",
     "iopub.status.busy": "2025-11-24T19:45:04.407601Z",
     "iopub.status.idle": "2025-11-24T19:45:04.602950Z",
     "shell.execute_reply": "2025-11-24T19:45:04.602171Z"
    },
    "papermill": {
     "duration": 0.205957,
     "end_time": "2025-11-24T19:45:04.604239",
     "exception": false,
     "start_time": "2025-11-24T19:45:04.398282",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "‚úÖ Gemini API key setup complete.\n"
     ]
    }
   ],
   "source": [
    "import os\n",
    "from kaggle_secrets import UserSecretsClient\n",
    "\n",
    "try:\n",
    "    GOOGLE_API_KEY = UserSecretsClient().get_secret(\"GOOGLE_API_KEY\")\n",
    "    os.environ[\"GOOGLE_API_KEY\"] = GOOGLE_API_KEY\n",
    "    print(\"‚úÖ Gemini API key setup complete.\")\n",
    "except Exception as e:\n",
    "    print(\n",
    "        f\"üîë Authentication Error: Please make sure you have added 'GOOGLE_API_KEY' to your Kaggle secrets. Details: {e}\"\n",
    "    )"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "60157c01",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:45:04.618828Z",
     "iopub.status.busy": "2025-11-24T19:45:04.618588Z",
     "iopub.status.idle": "2025-11-24T19:46:06.299753Z",
     "shell.execute_reply": "2025-11-24T19:46:06.298672Z"
    },
    "papermill": {
     "duration": 61.695521,
     "end_time": "2025-11-24T19:46:06.306414",
     "exception": false,
     "start_time": "2025-11-24T19:45:04.610893",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "‚úÖ ADK components imported successfully.\n"
     ]
    }
   ],
   "source": [
    "from google.adk.agents import Agent\n",
    "from google.adk.models.google_llm import Gemini\n",
    "from google.adk.runners import InMemoryRunner\n",
    "from google.adk.tools import google_search, AgentTool, ToolContext\n",
    "from google.genai import types\n",
    "from google.adk.agents import LlmAgent\n",
    "from google.adk.sessions import InMemorySessionService\n",
    "\n",
    "print(\"‚úÖ ADK components imported successfully.\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "98a6462e",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:06.321845Z",
     "iopub.status.busy": "2025-11-24T19:46:06.320814Z",
     "iopub.status.idle": "2025-11-24T19:46:06.327559Z",
     "shell.execute_reply": "2025-11-24T19:46:06.326620Z"
    },
    "papermill": {
     "duration": 0.016327,
     "end_time": "2025-11-24T19:46:06.328942",
     "exception": false,
     "start_time": "2025-11-24T19:46:06.312615",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "‚úÖ ADK components imported successfully.\n"
     ]
    }
   ],
   "source": [
    "import uuid\n",
    "from google.genai import types\n",
    "\n",
    "from google.adk.agents import LlmAgent\n",
    "from google.adk.models.google_llm import Gemini\n",
    "from google.adk.runners import Runner\n",
    "from google.adk.sessions import InMemorySessionService\n",
    "\n",
    "from google.adk.tools.mcp_tool.mcp_toolset import McpToolset\n",
    "from google.adk.tools.tool_context import ToolContext\n",
    "from google.adk.tools.mcp_tool.mcp_session_manager import StdioConnectionParams\n",
    "from mcp import StdioServerParameters\n",
    "\n",
    "from google.adk.apps.app import App, ResumabilityConfig\n",
    "from google.adk.tools.function_tool import FunctionTool\n",
    "\n",
    "print(\"‚úÖ ADK components imported successfully.\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "c42ae2ec",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:06.344506Z",
     "iopub.status.busy": "2025-11-24T19:46:06.343674Z",
     "iopub.status.idle": "2025-11-24T19:46:07.375070Z",
     "shell.execute_reply": "2025-11-24T19:46:07.373883Z"
    },
    "papermill": {
     "duration": 1.041348,
     "end_time": "2025-11-24T19:46:07.376879",
     "exception": false,
     "start_time": "2025-11-24T19:46:06.335531",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "‚úÖ Helper functions defined.\n"
     ]
    }
   ],
   "source": [
    "# Define helper functions that will be reused throughout the notebook\n",
    "\n",
    "from IPython.core.display import display, HTML\n",
    "from jupyter_server.serverapp import list_running_servers\n",
    "\n",
    "\n",
    "# Gets the proxied URL in the Kaggle Notebooks environment\n",
    "def get_adk_proxy_url():\n",
    "    PROXY_HOST = \"https://kkb-production.jupyter-proxy.kaggle.net\"\n",
    "    ADK_PORT = \"8000\"\n",
    "\n",
    "    servers = list(list_running_servers())\n",
    "    if not servers:\n",
    "        raise Exception(\"No running Jupyter servers found.\")\n",
    "\n",
    "    baseURL = servers[0][\"base_url\"]\n",
    "\n",
    "    try:\n",
    "        path_parts = baseURL.split(\"/\")\n",
    "        kernel = path_parts[2]\n",
    "        token = path_parts[3]\n",
    "    except IndexError:\n",
    "        raise Exception(f\"Could not parse kernel/token from base URL: {baseURL}\")\n",
    "\n",
    "    url_prefix = f\"/k/{kernel}/{token}/proxy/proxy/{ADK_PORT}\"\n",
    "    url = f\"{PROXY_HOST}{url_prefix}\"\n",
    "\n",
    "    styled_html = f\"\"\"\n",
    "    <div style=\"padding: 15px; border: 2px solid #f0ad4e; border-radius: 8px; background-color: #fef9f0; margin: 20px 0;\">\n",
    "        <div style=\"font-family: sans-serif; margin-bottom: 12px; color: #333; font-size: 1.1em;\">\n",
    "            <strong>‚ö†Ô∏è IMPORTANT: Action Required</strong>\n",
    "        </div>\n",
    "        <div style=\"font-family: sans-serif; margin-bottom: 15px; color: #333; line-height: 1.5;\">\n",
    "            The ADK web UI is <strong>not running yet</strong>. You must start it in the next cell.\n",
    "            <ol style=\"margin-top: 10px; padding-left: 20px;\">\n",
    "                <li style=\"margin-bottom: 5px;\"><strong>Run the next cell</strong> (the one with <code>!adk web ...</code>) to start the ADK web UI.</li>\n",
    "                <li style=\"margin-bottom: 5px;\">Wait for that cell to show it is \"Running\" (it will not \"complete\").</li>\n",
    "                <li>Once it's running, <strong>return to this button</strong> and click it to open the UI.</li>\n",
    "            </ol>\n",
    "            <em style=\"font-size: 0.9em; color: #555;\">(If you click the button before running the next cell, you will get a 500 error.)</em>\n",
    "        </div>\n",
    "        <a href='{url}' target='_blank' style=\"\n",
    "            display: inline-block; background-color: #1a73e8; color: white; padding: 10px 20px;\n",
    "            text-decoration: none; border-radius: 25px; font-family: sans-serif; font-weight: 500;\n",
    "            box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.2s ease;\">\n",
    "            Open ADK Web UI (after running cell below) ‚Üó\n",
    "        </a>\n",
    "    </div>\n",
    "    \"\"\"\n",
    "\n",
    "    display(HTML(styled_html))\n",
    "\n",
    "    return url_prefix\n",
    "\n",
    "\n",
    "print(\"‚úÖ Helper functions defined.\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "593dcd3e",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:07.400878Z",
     "iopub.status.busy": "2025-11-24T19:46:07.400076Z",
     "iopub.status.idle": "2025-11-24T19:46:07.407508Z",
     "shell.execute_reply": "2025-11-24T19:46:07.406460Z"
    },
    "papermill": {
     "duration": 0.022492,
     "end_time": "2025-11-24T19:46:07.409803",
     "exception": false,
     "start_time": "2025-11-24T19:46:07.387311",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "retry_config=types.HttpRetryOptions(\n",
    "    attempts=5,  # Maximum retry attempts\n",
    "    exp_base=7,  # Delay multiplier\n",
    "    initial_delay=1, # Initial delay before first retry (in seconds)\n",
    "    http_status_codes=[429, 500, 503, 504] # Retry on these HTTP errors\n",
    ")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "9064b738",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:07.424620Z",
     "iopub.status.busy": "2025-11-24T19:46:07.424370Z",
     "iopub.status.idle": "2025-11-24T19:46:07.430646Z",
     "shell.execute_reply": "2025-11-24T19:46:07.428789Z"
    },
    "papermill": {
     "duration": 0.015159,
     "end_time": "2025-11-24T19:46:07.432642",
     "exception": false,
     "start_time": "2025-11-24T19:46:07.417483",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "‚úÖ Root Agent defined.\n"
     ]
    }
   ],
   "source": [
    "iMedic = Agent(\n",
    "    name=\"iMedic\",\n",
    "    model=Gemini(\n",
    "        model=\"gemini-2.5-flash-lite\",\n",
    "        retry_options=retry_config\n",
    "    ),\n",
    "    description=\"A simple agent that can answer general questions.\",\n",
    "    instruction=\"You are a helpful assistant. Use Google Search for current info or if unsure.\",\n",
    "    tools=[google_search],\n",
    ")\n",
    "\n",
    "print(\"‚úÖ Root Agent defined.\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "12c41d99",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:07.450293Z",
     "iopub.status.busy": "2025-11-24T19:46:07.449589Z",
     "iopub.status.idle": "2025-11-24T19:46:07.457813Z",
     "shell.execute_reply": "2025-11-24T19:46:07.456923Z"
    },
    "papermill": {
     "duration": 0.018236,
     "end_time": "2025-11-24T19:46:07.459353",
     "exception": false,
     "start_time": "2025-11-24T19:46:07.441117",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "sucessfull\n",
      "{'status': 'success', 'message': 'Appointment booked successfully!', 'appointment': {'patient_name': 'John Doe', 'doctor_name': 'Dr. Rahim', 'date': '2025-01-10', 'time': '14:30', 'symptoms': 'Headache'}}\n"
     ]
    }
   ],
   "source": [
    "from datetime import datetime\n",
    "\n",
    "# Simple in-memory database (You can replace this with a real DB)\n",
    "appointments = []\n",
    "\n",
    "def book_doctor_appointment(patient_name: str,\n",
    "                            doctor_name: str,\n",
    "                            date: str,\n",
    "                            time: str,\n",
    "                            symptoms: str = \"\") -> dict:\n",
    "    \"\"\"\n",
    "    Book a doctor appointment with validation.\n",
    "    \n",
    "    Args:\n",
    "        patient_name (str): Name of the patient.\n",
    "        doctor_name (str): Name of the doctor.\n",
    "        date (str): Appointment date in YYYY-MM-DD format.\n",
    "        time (str): Appointment time in HH:MM (24hr) format.\n",
    "        symptoms (str): Optional - patient's symptoms.\n",
    "\n",
    "    Returns:\n",
    "        dict: Confirmation or error message.\n",
    "    \"\"\"\n",
    "\n",
    "    # Validate date\n",
    "    try:\n",
    "        appointment_date = datetime.strptime(date, \"%Y-%m-%d\").date()\n",
    "    except ValueError:\n",
    "        return {\"status\": \"error\", \"message\": \"Invalid date format. Use YYYY-MM-DD\"}\n",
    "\n",
    "    # Validate time\n",
    "    try:\n",
    "        appointment_time = datetime.strptime(time, \"%H:%M\").time()\n",
    "    except ValueError:\n",
    "        return {\"status\": \"error\", \"message\": \"Invalid time format. Use HH:MM (24hr)\"}\n",
    "\n",
    "    # Check if time slot is already booked\n",
    "    for appt in appointments:\n",
    "        if (appt[\"doctor_name\"].lower() == doctor_name.lower() and\n",
    "            appt[\"date\"] == date and\n",
    "            appt[\"time\"] == time):\n",
    "            return {\n",
    "                \"status\": \"error\",\n",
    "                \"message\": f\"Doctor {doctor_name} is already booked at {time} on {date}.\"\n",
    "            }\n",
    "\n",
    "    # Save appointment\n",
    "    appointment = {\n",
    "        \"patient_name\": patient_name,\n",
    "        \"doctor_name\": doctor_name,\n",
    "        \"date\": date,\n",
    "        \"time\": time,\n",
    "        \"symptoms\": symptoms\n",
    "    }\n",
    "\n",
    "    appointments.append(appointment)\n",
    "\n",
    "    return {\n",
    "        \"status\": \"success\",\n",
    "        \"message\": \"Appointment booked successfully!\",\n",
    "        \"appointment\": appointment\n",
    "    }\n",
    "\n",
    "\n",
    "# Example usage:\n",
    "\n",
    "print(\"sucessfull\")\n",
    "print(book_doctor_appointment(\"John Doe\", \"Dr. Rahim\", \"2025-01-10\", \"14:30\", \"Headache\"))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "79eea474",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:07.474599Z",
     "iopub.status.busy": "2025-11-24T19:46:07.474325Z",
     "iopub.status.idle": "2025-11-24T19:46:07.481120Z",
     "shell.execute_reply": "2025-11-24T19:46:07.479822Z"
    },
    "papermill": {
     "duration": 0.015997,
     "end_time": "2025-11-24T19:46:07.482845",
     "exception": false,
     "start_time": "2025-11-24T19:46:07.466848",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "‚úÖ Doctor booking agent created with custom function tools\n",
      "üîß Available tools:\n"
     ]
    }
   ],
   "source": [
    "# booking agent with custom function tools\n",
    "booking_agent = LlmAgent(\n",
    "    name=\"booking_agent\",\n",
    "    model=Gemini(model=\"gemini-2.5-flash-lite\", retry_options=retry_config),\n",
    "    instruction=\"\"\"You are a smart booking agent assistant.\n",
    "\n",
    "    For currency conversion requests:\n",
    "    1. Use `book_doctor_appointment()` for booking\n",
    "    3. Check the \"status\" field in each tool's response for errors\n",
    "    4.If any tool returns status \"error\", explain the issue to the user clearly.\n",
    "    5. give the result json formet\n",
    "    6. after booking the appoinment give it json formet\n",
    "    \"\"\",\n",
    "    tools=[book_doctor_appointment],\n",
    ")\n",
    "\n",
    "print(\"‚úÖ Doctor booking agent created with custom function tools\")\n",
    "print(\"üîß Available tools:\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "a3bdb29b",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:07.499569Z",
     "iopub.status.busy": "2025-11-24T19:46:07.499272Z",
     "iopub.status.idle": "2025-11-24T19:46:07.504627Z",
     "shell.execute_reply": "2025-11-24T19:46:07.503689Z"
    },
    "papermill": {
     "duration": 0.015242,
     "end_time": "2025-11-24T19:46:07.506003",
     "exception": false,
     "start_time": "2025-11-24T19:46:07.490761",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "‚úÖ Runner created.\n"
     ]
    }
   ],
   "source": [
    "# Test the booking agent\n",
    "runner = InMemoryRunner(agent=booking_agent)\n",
    "print(\"‚úÖ Runner created.\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "56864e25",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:07.521403Z",
     "iopub.status.busy": "2025-11-24T19:46:07.520983Z",
     "iopub.status.idle": "2025-11-24T19:46:07.525893Z",
     "shell.execute_reply": "2025-11-24T19:46:07.524788Z"
    },
    "papermill": {
     "duration": 0.014669,
     "end_time": "2025-11-24T19:46:07.527402",
     "exception": false,
     "start_time": "2025-11-24T19:46:07.512733",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "#response = await runner.run_debug(\" book a doctor\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "cd07e438",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:07.542983Z",
     "iopub.status.busy": "2025-11-24T19:46:07.542718Z",
     "iopub.status.idle": "2025-11-24T19:46:07.546841Z",
     "shell.execute_reply": "2025-11-24T19:46:07.545856Z"
    },
    "papermill": {
     "duration": 0.013758,
     "end_time": "2025-11-24T19:46:07.548501",
     "exception": false,
     "start_time": "2025-11-24T19:46:07.534743",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "#response = await runner.run_debug(\"How to add this info\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "fcafef27",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:07.563978Z",
     "iopub.status.busy": "2025-11-24T19:46:07.563724Z",
     "iopub.status.idle": "2025-11-24T19:46:09.780323Z",
     "shell.execute_reply": "2025-11-24T19:46:09.779346Z"
    },
    "papermill": {
     "duration": 2.226148,
     "end_time": "2025-11-24T19:46:09.781601",
     "exception": false,
     "start_time": "2025-11-24T19:46:07.555453",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      " ### Created new session: debug_session_id\n",
      "\n",
      "User > Kaykubad Dr. saynoor 2025/10/24 9.00AM skinissues\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "WARNING:google_genai.types:Warning: there are non-text parts in the response: ['function_call'], returning concatenated text result from text parts. Check the full candidates.content.parts accessor to get the full model response.\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "booking_agent > Yes, the appointment is confirmed with Dr. saynoor for Kaykubad on 2025-10-24 at 09:00 AM for skin issues.\n",
      "```json\n",
      "{\n",
      "  \"appointment\": {\n",
      "    \"date\": \"2025-10-24\",\n",
      "    \"doctor_name\": \"Dr. saynoor\",\n",
      "    \"patient_name\": \"Kaykubad\",\n",
      "    \"symptoms\": \"skinissues\",\n",
      "    \"time\": \"09:00\"\n",
      "  },\n",
      "  \"message\": \"Appointment booked successfully!\",\n",
      "  \"status\": \"success\"\n",
      "}\n",
      "```\n"
     ]
    }
   ],
   "source": [
    "response = await runner.run_debug(\"Kaykubad Dr. saynoor 2025/10/24 9.00AM skinissues\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "6dcbaef8",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:09.797789Z",
     "iopub.status.busy": "2025-11-24T19:46:09.797492Z",
     "iopub.status.idle": "2025-11-24T19:46:09.805913Z",
     "shell.execute_reply": "2025-11-24T19:46:09.805197Z"
    },
    "papermill": {
     "duration": 0.018735,
     "end_time": "2025-11-24T19:46:09.807441",
     "exception": false,
     "start_time": "2025-11-24T19:46:09.788706",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "import uuid\n",
    "from datetime import datetime\n",
    "\n",
    "# Fake medicine inventory (replace with database in real app)\n",
    "medicine_inventory = {\n",
    "    \"Paracetamol 500mg\": {\"price\": 5.0, \"stock\": 50},\n",
    "    \"Aspirin 300mg\": {\"price\": 8.0, \"stock\": 20},\n",
    "    \"Amoxicillin 250mg\": {\"price\": 15.0, \"stock\": 10},\n",
    "    \"Cetirizine 10mg\": {\"price\": 3.0, \"stock\": 40},\n",
    "}\n",
    "\n",
    "orders = []\n",
    "\n",
    "\n",
    "def book_medicine_online(customer_name: str,\n",
    "                         medicine_name: str,\n",
    "                         quantity: int,\n",
    "                         address: str,\n",
    "                         phone: str):\n",
    "    \"\"\"\n",
    "    Book/order medicine online with stock validation and 5% service charge.\n",
    "    \"\"\"\n",
    "\n",
    "    # Validate input\n",
    "    if quantity <= 0:\n",
    "        return {\"status\": \"error\", \"message\": \"Quantity must be greater than zero.\"}\n",
    "\n",
    "    if medicine_name not in medicine_inventory:\n",
    "        return {\"status\": \"error\", \"message\": f\"{medicine_name} not found in inventory.\"}\n",
    "\n",
    "    med = medicine_inventory[medicine_name]\n",
    "\n",
    "    # Stock check\n",
    "    if quantity > med[\"stock\"]:\n",
    "        return {\n",
    "            \"status\": \"error\",\n",
    "            \"message\": f\"Only {med['stock']} units of {medicine_name} available.\"\n",
    "        }\n",
    "\n",
    "    # Base price\n",
    "    base_price = quantity * med[\"price\"]\n",
    "\n",
    "    # Service charge 5%\n",
    "    service_charge = base_price * 0.05\n",
    "\n",
    "    # Final total\n",
    "    total_price = base_price + service_charge\n",
    "\n",
    "    # Update stock\n",
    "    medicine_inventory[medicine_name][\"stock\"] -= quantity\n",
    "\n",
    "    # Order data\n",
    "    order = {\n",
    "        \"order_id\": str(uuid.uuid4()),\n",
    "        \"customer_name\": customer_name,\n",
    "        \"medicine_name\": medicine_name,\n",
    "        \"quantity\": quantity,\n",
    "        \"base_price\": base_price,\n",
    "        \"service_charge_5_percent\": service_charge,\n",
    "        \"total_price\": total_price,\n",
    "        \"address\": address,\n",
    "        \"phone\": phone,\n",
    "        \"order_time\": datetime.now().isoformat()\n",
    "    }\n",
    "\n",
    "    orders.append(order)\n",
    "\n",
    "    return {\n",
    "        \"status\": \"success\",\n",
    "        \"message\": \"Medicine ordered successfully!\",\n",
    "        \"order\": order\n",
    "    }\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "3d18ce0b",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:09.823485Z",
     "iopub.status.busy": "2025-11-24T19:46:09.822907Z",
     "iopub.status.idle": "2025-11-24T19:46:09.826967Z",
     "shell.execute_reply": "2025-11-24T19:46:09.826206Z"
    },
    "papermill": {
     "duration": 0.013984,
     "end_time": "2025-11-24T19:46:09.828633",
     "exception": false,
     "start_time": "2025-11-24T19:46:09.814649",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "{'status': 'success', 'message': 'Medicine ordered successfully!', 'order': {'order_id': 'cf5e13c8-23e0-44c5-aa25-c3de9749ef30', 'customer_name': 'John Doe', 'medicine_name': 'Paracetamol 500mg', 'quantity': 3, 'base_price': 15.0, 'service_charge_5_percent': 0.75, 'total_price': 15.75, 'address': 'Dhaka, Bangladesh', 'phone': '017xxxxxxxx', 'order_time': '2025-11-24T19:46:09.824437'}}\n"
     ]
    }
   ],
   "source": [
    "# ---------- TEST ----------\n",
    "print(book_medicine_online(\n",
    "    \"John Doe\",\n",
    "    \"Paracetamol 500mg\",\n",
    "    3,\n",
    "    \"Dhaka, Bangladesh\",\n",
    "    \"017xxxxxxxx\"\n",
    "))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "ae3d875f",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:09.844300Z",
     "iopub.status.busy": "2025-11-24T19:46:09.843760Z",
     "iopub.status.idle": "2025-11-24T19:46:09.849665Z",
     "shell.execute_reply": "2025-11-24T19:46:09.848629Z"
    },
    "papermill": {
     "duration": 0.015812,
     "end_time": "2025-11-24T19:46:09.851020",
     "exception": false,
     "start_time": "2025-11-24T19:46:09.835208",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "‚úÖ Runner created.\n"
     ]
    }
   ],
   "source": [
    "# booking agent with custom function tools\n",
    "medicbooking_agent = LlmAgent(\n",
    "    name=\"medicbooking_agent\",\n",
    "    model=Gemini(model=\"gemini-2.5-flash-lite\", retry_options=retry_config),\n",
    "    instruction=\"\"\"You are a smart booking agent assistant.\n",
    "\n",
    "    For medicine order conversion requests:\n",
    "    1. Use `book_medicine_online()` for booking\n",
    "    3. Check the \"status\" field in each tool's response for errors\n",
    "    4.If any tool returns status \"error\", explain the issue to the user clearly.\n",
    "    5. give the result json formet\n",
    "    6. ask everything and accept the data\n",
    "    6. after confirm the order give it json formet with its service charge result and suceessful message.\n",
    "    \"\"\",\n",
    "    tools=[book_medicine_online],\n",
    ")\n",
    "runner = InMemoryRunner(agent=medicbooking_agent)\n",
    "print(\"‚úÖ Runner created.\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "id": "089ca3bc",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:09.867625Z",
     "iopub.status.busy": "2025-11-24T19:46:09.866703Z",
     "iopub.status.idle": "2025-11-24T19:46:10.493614Z",
     "shell.execute_reply": "2025-11-24T19:46:10.492577Z"
    },
    "papermill": {
     "duration": 0.63671,
     "end_time": "2025-11-24T19:46:10.495013",
     "exception": false,
     "start_time": "2025-11-24T19:46:09.858303",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      " ### Created new session: debug_session_id\n",
      "\n",
      "User > how to order medicine\n",
      "medicbooking_agent > How can I help you with your medicine order? Please provide me with the medicine name, quantity, your name, and delivery address.\n"
     ]
    }
   ],
   "source": [
    "response = await runner.run_debug(\"how to order medicine\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "id": "85b55d4b",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:10.510299Z",
     "iopub.status.busy": "2025-11-24T19:46:10.509705Z",
     "iopub.status.idle": "2025-11-24T19:46:10.823511Z",
     "shell.execute_reply": "2025-11-24T19:46:10.822623Z"
    },
    "papermill": {
     "duration": 0.32275,
     "end_time": "2025-11-24T19:46:10.824924",
     "exception": false,
     "start_time": "2025-11-24T19:46:10.502174",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      " ### Continue session: debug_session_id\n",
      "\n",
      "User > turag Paracetamol 500mg 5pcs Dhaka 019888888\n",
      "medicbooking_agent > Could you please provide your name and confirm the delivery address?\n"
     ]
    }
   ],
   "source": [
    "response = await runner.run_debug(\"turag Paracetamol 500mg 5pcs Dhaka 019888888\")\n",
    "                                            "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "id": "93ca1365",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:10.842411Z",
     "iopub.status.busy": "2025-11-24T19:46:10.841666Z",
     "iopub.status.idle": "2025-11-24T19:46:11.586957Z",
     "shell.execute_reply": "2025-11-24T19:46:11.586214Z"
    },
    "papermill": {
     "duration": 0.755263,
     "end_time": "2025-11-24T19:46:11.588090",
     "exception": false,
     "start_time": "2025-11-24T19:46:10.832827",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      " ### Continue session: debug_session_id\n",
      "\n",
      "User > confirm this\n",
      "medicbooking_agent > I'm sorry, but I need a bit more information to proceed. Could you please provide your name and the full delivery address, including any relevant details like area or road name?\n"
     ]
    }
   ],
   "source": [
    "response = await runner.run_debug('confirm this')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 19,
   "id": "d94f823f",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:11.605963Z",
     "iopub.status.busy": "2025-11-24T19:46:11.605402Z",
     "iopub.status.idle": "2025-11-24T19:46:11.610294Z",
     "shell.execute_reply": "2025-11-24T19:46:11.609460Z"
    },
    "papermill": {
     "duration": 0.015889,
     "end_time": "2025-11-24T19:46:11.611859",
     "exception": false,
     "start_time": "2025-11-24T19:46:11.595970",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "medical_booking_order_agent = LlmAgent(\n",
    "    name=\"medical_booking_order_agent\",\n",
    "    model=Gemini(model=\"gemini-2.5-flash-lite\", retry_options=retry_config),\n",
    "    # Updated instruction\n",
    "    instruction=\"\"\"You are a smart doctor booking and medicine order assistant. You must strictly follow these steps and use the available tools.\n",
    "\n",
    "  For any doctor booking or medicine order conversion request:\n",
    "\n",
    "   1. for doctor booking: Use the book_doctor_appointment() tool to book the doctor for patient.\n",
    "   2. for medicine order : Use the book_medicine_online() tool to confirm the order.\n",
    "   3. Error Check: After each tool call, you must check the \"status\" field in the response. If the status is \"error\", you must stop and clearly explain the issue to the user.\n",
    "   4. Provide Detailed Breakdown: In your summary, you must:\n",
    "       * State the final result in json formet.\n",
    "       * Explain how the result was how it work, including:\n",
    "           * The fee percentage and the fee amount \n",
    "    \"\"\",\n",
    "    tools=[book_doctor_appointment,\n",
    "           book_medicine_online,\n",
    "        AgentTool(agent=iMedic),  # Using another agent as a tool!\n",
    "    ],\n",
    ")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 20,
   "id": "27697747",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:11.629364Z",
     "iopub.status.busy": "2025-11-24T19:46:11.628734Z",
     "iopub.status.idle": "2025-11-24T19:46:11.633513Z",
     "shell.execute_reply": "2025-11-24T19:46:11.632694Z"
    },
    "papermill": {
     "duration": 0.015057,
     "end_time": "2025-11-24T19:46:11.634801",
     "exception": false,
     "start_time": "2025-11-24T19:46:11.619744",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "‚úÖ Runner created.\n"
     ]
    }
   ],
   "source": [
    "runner = InMemoryRunner(agent=medical_booking_order_agent)\n",
    "print(\"‚úÖ Runner created.\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 21,
   "id": "83fca79f",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:11.652365Z",
     "iopub.status.busy": "2025-11-24T19:46:11.651712Z",
     "iopub.status.idle": "2025-11-24T19:46:12.512800Z",
     "shell.execute_reply": "2025-11-24T19:46:12.511617Z"
    },
    "papermill": {
     "duration": 0.871388,
     "end_time": "2025-11-24T19:46:12.514207",
     "exception": false,
     "start_time": "2025-11-24T19:46:11.642819",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      " ### Created new session: debug_session_id\n",
      "\n",
      "User > what is your agent name?\n",
      "medical_booking_order_agent > I am the medical_booking_order_agent.\n"
     ]
    }
   ],
   "source": [
    "response = await runner.run_debug(\"what is your agent name?\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 22,
   "id": "577c0bf4",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:12.531678Z",
     "iopub.status.busy": "2025-11-24T19:46:12.531388Z",
     "iopub.status.idle": "2025-11-24T19:46:12.536209Z",
     "shell.execute_reply": "2025-11-24T19:46:12.535164Z"
    },
    "papermill": {
     "duration": 0.0154,
     "end_time": "2025-11-24T19:46:12.537845",
     "exception": false,
     "start_time": "2025-11-24T19:46:12.522445",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "#!adk create medical_booking_order_agent --model gemini-2.5-flash-lite --api_key $GOOGLE_API_KEY"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 23,
   "id": "e683e4a3",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:12.555486Z",
     "iopub.status.busy": "2025-11-24T19:46:12.554836Z",
     "iopub.status.idle": "2025-11-24T19:46:12.558490Z",
     "shell.execute_reply": "2025-11-24T19:46:12.557779Z"
    },
    "papermill": {
     "duration": 0.014151,
     "end_time": "2025-11-24T19:46:12.560034",
     "exception": false,
     "start_time": "2025-11-24T19:46:12.545883",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "#url_prefix = get_adk_proxy_url()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 24,
   "id": "aee8946e",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:12.577102Z",
     "iopub.status.busy": "2025-11-24T19:46:12.576354Z",
     "iopub.status.idle": "2025-11-24T19:46:12.580188Z",
     "shell.execute_reply": "2025-11-24T19:46:12.579436Z"
    },
    "papermill": {
     "duration": 0.013727,
     "end_time": "2025-11-24T19:46:12.581811",
     "exception": false,
     "start_time": "2025-11-24T19:46:12.568084",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "#!adk web --url_prefix {url_prefix}"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 25,
   "id": "0a9b4ede",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:12.599511Z",
     "iopub.status.busy": "2025-11-24T19:46:12.599176Z",
     "iopub.status.idle": "2025-11-24T19:46:12.605382Z",
     "shell.execute_reply": "2025-11-24T19:46:12.604342Z"
    },
    "papermill": {
     "duration": 0.01707,
     "end_time": "2025-11-24T19:46:12.606968",
     "exception": false,
     "start_time": "2025-11-24T19:46:12.589898",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "from google.genai import types\n",
    "from google.adk import Agent\n",
    "\n",
    "data_analyst = Agent(\n",
    "   model='gemini-2.5-flash',\n",
    "   name=\"data_analyst\",\n",
    "   description=\"\"\"Agent that analyzes the details on user insurance policy and \n",
    "   medical necessity for a pre-authorization request and creates a report on\n",
    "   the same.\"\"\",\n",
    "   instruction=f\"\"\"\n",
    "   As an **Information Analysis and Report Generator Agent**, your primary role \n",
    "   is to evaluate pre-authorization requests for medical treatments.\n",
    "\n",
    "    **Here's the process you will follow:**\n",
    "\n",
    "    1.  **Receive Information:** You will be provided with two sets of crucial \n",
    "    information:\n",
    "        * **User's Insurance Coverage Details:** Information pertaining to the \n",
    "        user's insurance policy and its coverage for the requested treatment.\n",
    "        * **User's Medical Records:** Relevant medical history and details \n",
    "        concerning the treatment for which pre-authorization is sought.\n",
    "\n",
    "    2.  **Analyze and Decide:**\n",
    "        * Thoroughly **review and analyze** both the insurance coverage details \n",
    "        and the user's medical records.\n",
    "        * Based on this analysis, make a **clear decision** to either **\"Pass\" \n",
    "        or \"Reject\"** the pre-authorization request.\n",
    "        * Formulate a **reason for the decision**, explicitly referencing \n",
    "        relevant information from the patient's medical records and the \n",
    "        insurance policy eligibility criteria.\n",
    "\n",
    "    3.  **Generate Report Content:**\n",
    "        * Create the **content for a pre-authorization decision report** that \n",
    "        will be compiled into a PDF file.\n",
    "        * The report must include:\n",
    "            * **Patient Details:** Essential identifying information about the\n",
    "            patient.\n",
    "            * **Treatment Details:** A description of the treatment for which \n",
    "            pre-authorization was requested.\n",
    "            * **Pre-authorization Decision:** Clearly state \"Pass\" or \"Reject.\"\n",
    "            * **Reason for Decision:** Provide the specific justification for \n",
    "            the decision, as determined in the previous step.\n",
    "        * **Reference:** Use the provided sample report content as a **structural\n",
    "         and formatting reference** for generating this report.\n",
    "\n",
    "    4.  **Upload Document:**\n",
    "        * Once the PDF content is generated, use the `store_pdf` tool to **upload \n",
    "        the content as a PDF file** to the designated Cloud Storage Bucket.\n",
    "\n",
    "    5.  **Confirm to User:**\n",
    "        * After the proposal report document's PDF content has been successfully \n",
    "        created and uploaded to the Cloud Storage Bucket, send a confirmation \n",
    "        message to the user, stating that \"The pre-authorization decision report \n",
    "        has been created and uploaded to the Cloud Storage Bucket.\" Provide the \n",
    "        path of the GCS report location to the user. Prepend \n",
    "        \"https://storage.cloud.google.com/\" to the path instead of \"gs:\". \n",
    "        *Also provide a brief summary of the decision to the user.\n",
    "        \n",
    "    6. Here is a sample report \n",
    "    SAMPLE_REPORT=\n",
    "*****************************Sample Report Document Template***********\n",
    "Medical Pre-Authorization Request Report\n",
    "Date of Report: July 19, 2025\n",
    "\n",
    "Pre-Authorization for Elective LASIK Surgery (Rejection)\n",
    "Patient Name: Mark Johnson\n",
    "\n",
    "Treatment Name: Bilateral LASIK Eye Surgery\n",
    "\n",
    "Insurance Provider: OptiCare Health Plans\n",
    "\n",
    "Summary of Medical Records:\n",
    "Patient Mark Johnson seeks LASIK surgery for refractive error correction to \n",
    "reduce dependence on eyeglasses. Corrected visual acuity is 20/25 in both eyes. \n",
    "No medical contraindications to continued use of corrective lenses or severe \n",
    "uncorrectable refractive error are noted.\n",
    "\n",
    "Summary of Insurance Coverage:\n",
    "OptiCare Health Plans policy (Policy ID: LASIK-ELEC-MJ-2024) was reviewed. The\n",
    "policy explicitly categorizes LASIK as an elective/cosmetic procedure. Coverage\n",
    "is provided only in cases of severe refractive error (e.g., >7.5 diopters) or \n",
    "documented medical intolerance to traditional corrective lenses \n",
    "(glasses/contacts). Neither of these criteria is met.\n",
    "\n",
    "Pre-Authorization Claim Decision: REJECTED\n",
    "Reason for Rejection: The requested procedure (Bilateral LASIK Eye Surgery) is \n",
    "categorized as an elective cosmetic procedure under the patient's OptiCare \n",
    "Health Plans policy and does not meet the strict medical necessity criteria for\n",
    "coverage.\n",
    "    \"\"\",\n",
    "   generate_content_config=types.GenerateContentConfig(temperature=0.2),\n",
    "   \n",
    ")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 26,
   "id": "68c1fb95",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:12.624701Z",
     "iopub.status.busy": "2025-11-24T19:46:12.624370Z",
     "iopub.status.idle": "2025-11-24T19:46:12.638821Z",
     "shell.execute_reply": "2025-11-24T19:46:12.637694Z"
    },
    "papermill": {
     "duration": 0.02541,
     "end_time": "2025-11-24T19:46:12.640489",
     "exception": false,
     "start_time": "2025-11-24T19:46:12.615079",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "import google.cloud.aiplatform as aiplatform\n",
    "from google import genai\n",
    "from google.genai import types\n",
    "from typing import Optional\n",
    "from dotenv import load_dotenv\n",
    "from pathlib import Path\n",
    "import warnings\n",
    "import os\n",
    "import logging\n",
    "import base64\n",
    "\n",
    "\n",
    "def extract_treatment_name(user_query: str) -> str:\n",
    "    \"\"\"\n",
    "    Extracts the treatment name from a user query using the Gemini model.\n",
    "\n",
    "    Args:\n",
    "        user_query: The user's input query.\n",
    "\n",
    "    Returns:\n",
    "        The extracted treatment name, or an empty string if not found.\n",
    "    \"\"\"\n",
    "    # Initialize the Gemini model\n",
    "    client = genai.Client(\n",
    "      vertexai=True,\n",
    "      project=GOOGLE_CLOUD_PROJECT,  \n",
    "      location=GOOGLE_CLOUD_LOCATION,           \n",
    "  )\n",
    "\n",
    "    model = \"gemini-2.5-flash\"\n",
    "\n",
    "    # Construct a prompt for the Gemini model to extract the treatment name\n",
    "    si_text = f\"\"\"\n",
    "    From the following user query, extract only the name of the medical treatment.\n",
    "    If no specific treatment is mentioned, respond with \"None\".\n",
    "\n",
    "    User Query: \"{user_query}\"\n",
    "\n",
    "    Treatment Name:\n",
    "    \"\"\"\n",
    "\n",
    "    contents = [\n",
    "    types.Content(\n",
    "      role=\"user\",\n",
    "      parts=[\n",
    "        types.Part.from_text(text=user_query)\n",
    "      ]\n",
    "    ),\n",
    "    ]\n",
    "\n",
    "    generate_content_config = types.GenerateContentConfig(\n",
    "    temperature = 1,\n",
    "    top_p = 1,\n",
    "    seed = 0,\n",
    "    max_output_tokens = 65535,\n",
    "    system_instruction=[types.Part.from_text(text=si_text)],\n",
    "    thinking_config=types.ThinkingConfig(\n",
    "      thinking_budget=-1,\n",
    "    ),\n",
    "    )\n",
    "\n",
    "    generated_text = \"\"\n",
    "    try:\n",
    "        # Stream the content generation and concatenate chunks\n",
    "        for chunk in client.models.generate_content_stream(\n",
    "        model = model,\n",
    "        contents = contents,\n",
    "        config = generate_content_config,\n",
    "        ):\n",
    "            generated_text += chunk.text\n",
    "    except Exception as e:\n",
    "        print(f\"An error occurred during content generation: {e}\")\n",
    "        return \"Error generating response.\"\n",
    "\n",
    "    return generated_text.strip()\n",
    "\n",
    "def extract_policy_information(policy_file: str, treatment_name: str) -> str:\n",
    "    \"\"\"\n",
    "    Extracts all information related to a specific treatment from insurance policy pdf\n",
    "    using the Gemini model.\n",
    "\n",
    "    Args:\n",
    "        policy_file: The full text of the insurance policy.\n",
    "        treatment_name: The name of the treatment to find information about.\n",
    "\n",
    "    Returns:\n",
    "        Relevant information about the treatment, or a message indicating it's not found.\n",
    "    \"\"\"\n",
    "    client = genai.Client(\n",
    "        vertexai=True,\n",
    "        project=GOOGLE_CLOUD_PROJECT,\n",
    "        location=GOOGLE_CLOUD_LOCATION,\n",
    "    )\n",
    "\n",
    "    \n",
    "    # with open(policy_file_path, 'rb') as pdf_file:\n",
    "    #     pdf_bytes = pdf_file.read()\n",
    "\n",
    "    \n",
    "\n",
    "    # Define the text part of the prompt\n",
    "    prompt_text = types.Part.from_text(text=f\"\"\"\n",
    "    You are an AI assistant specialized in analyzing insurance policy documents.\n",
    "    Given the following insurance policy text, extract all details and clauses\n",
    "    specifically related to the medical treatment named \\\"{treatment_name}\"\\.\n",
    "    Include information about coverage, exclusions, limits, conditions,\n",
    "    and any other relevant terms.\n",
    "\n",
    "    If \\\"{treatment_name}\"\\ is not explicitly mentioned or no information\n",
    "    is found regarding it, state \\\\\\\"No specific information found for {treatment_name}.\n",
    "    \n",
    "    Insurance policy text: {policy_file}\"\"\")\n",
    "\n",
    "    model = \"gemini-2.5-flash\"\n",
    "    contents = [\n",
    "        types.Content(\n",
    "            role=\"user\",\n",
    "            parts=[\n",
    "                prompt_text\n",
    "            ]\n",
    "        ),\n",
    "    ]\n",
    "\n",
    "    generate_content_config = types.GenerateContentConfig(\n",
    "        temperature = 1,\n",
    "        top_p = 0.95,\n",
    "        max_output_tokens = 65535,\n",
    "        thinking_config=types.ThinkingConfig(\n",
    "            thinking_budget=0,\n",
    "        ),\n",
    "    )\n",
    "\n",
    "    summary_output = \"\"\n",
    "    # Stream the content generation\n",
    "    for chunk in client.models.generate_content_stream(\n",
    "        model = model,\n",
    "        contents = contents,\n",
    "        config = generate_content_config,\n",
    "    ):\n",
    "        summary_output += chunk.text\n",
    "    return summary_output\n",
    "\n",
    "\n",
    "def extract_medical_details(medical_report_file: str, treatment_name: str) -> str:\n",
    "    \"\"\"\n",
    "    Extracts all information related to a specific treatment from medical report pdf\n",
    "    using the Gemini model\n",
    "\n",
    "    Args:\n",
    "        medical_report_file (str): The full text of the medical report.\n",
    "        treatment_name: The name of the treatment to find information about.\n",
    "\n",
    "    Returns: A summary of the relevant medical details\n",
    "    \"\"\"\n",
    "    client = genai.Client(\n",
    "        vertexai=True,\n",
    "        project=GOOGLE_CLOUD_PROJECT,\n",
    "        location=GOOGLE_CLOUD_LOCATION,\n",
    "    )\n",
    "\n",
    "\n",
    "    # Define the text part of the prompt\n",
    "    prompt_text = types.Part.from_text(text=\"\"\"You are an AI assistant specialized in analyzing medical reports. \n",
    "    Given the following medical report txt, extract and summarize all relevant medical details specifically \n",
    "    related to the treatment named \\\"{treatment_name}\\\". Include information about diagnosis, treatment plans, \n",
    "    medications, procedures, and patient outcomes. If \\\"{treatment_name}\\\" is not explicitly mentioned or no\n",
    "    information is found regarding it, state \\\\\\\"No specific information found for {treatment_name}.\n",
    "    \n",
    "    Medical report text {medical_report_file}\"\"\")\n",
    "\n",
    "\n",
    "    model = \"gemini-2.5-flash\"\n",
    "    contents = [\n",
    "        types.Content(\n",
    "            role=\"user\",\n",
    "            parts=[\n",
    "                prompt_text\n",
    "            ]\n",
    "        ),\n",
    "    ]\n",
    "\n",
    "    generate_content_config = types.GenerateContentConfig(\n",
    "        temperature = 1,\n",
    "        top_p = 0.95,\n",
    "        max_output_tokens = 65535,\n",
    "        thinking_config=types.ThinkingConfig(\n",
    "            thinking_budget=0,\n",
    "        ),\n",
    "    )\n",
    "\n",
    "    summary_output = \"\"\n",
    "    # Stream the content generation\n",
    "    for chunk in client.models.generate_content_stream(\n",
    "        model = model,\n",
    "        contents = contents,\n",
    "        config = generate_content_config,\n",
    "    ):\n",
    "        summary_output += chunk.text\n",
    "    return summary_output"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 27,
   "id": "a3caa39d",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:12.658646Z",
     "iopub.status.busy": "2025-11-24T19:46:12.657732Z",
     "iopub.status.idle": "2025-11-24T19:46:12.663762Z",
     "shell.execute_reply": "2025-11-24T19:46:12.662697Z"
    },
    "papermill": {
     "duration": 0.016954,
     "end_time": "2025-11-24T19:46:12.665342",
     "exception": false,
     "start_time": "2025-11-24T19:46:12.648388",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "from google import genai\n",
    "from google.adk.agents import Agent\n",
    "from google.genai import types\n",
    "\n",
    "information_extractor= Agent(\n",
    "   model='gemini-2.5-flash',\n",
    "   name=\"information_extractor\",\n",
    "   description=\"\"\"Agent that extracts the details on user insurance policy and\n",
    "   medical necessity for a pre-authorization request from documents provided \n",
    "   by the user.\"\"\",\n",
    "   instruction=  \"\"\"\n",
    "    You are a information extractor agent that helps with extracting \n",
    "    details on treatment name from user request. You also extract policy\n",
    "    details and medical test details on that treatment from respective\n",
    "    documents provided by the user. You will have below information:\n",
    "    1) user request containing treatment name for which they are seeking\n",
    "    pre-authorization.\n",
    "    2) a medical report containing details on tests and diagnosis for that\n",
    "    treatment\n",
    "    3) a insurance policy document containing details on insurance coverage\n",
    "    and eligibility for that treatment.\n",
    "    First you take the user request and extract the treatment name for which\n",
    "    user is seeking pre-authorization using extract_treatment_name. Give\n",
    "    medical record document path and extracted treatment name to\n",
    "    extract_medical_details tool and extract details on medical records. Give\n",
    "    insurance policy document path and extracted treatment name to\n",
    "    extract_policy_information tool and extract details on policy. Call\n",
    "    extract_medical_details and extract_policy_information parallely if you\n",
    "    have both the documents.\n",
    "    \"\"\",\n",
    "   generate_content_config=types.GenerateContentConfig(temperature=0.2),\n",
    "   tools=[extract_treatment_name, extract_policy_information, extract_medical_details],\n",
    ")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 28,
   "id": "998b16fd",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:12.682684Z",
     "iopub.status.busy": "2025-11-24T19:46:12.681953Z",
     "iopub.status.idle": "2025-11-24T19:46:12.689171Z",
     "shell.execute_reply": "2025-11-24T19:46:12.687980Z"
    },
    "papermill": {
     "duration": 0.017544,
     "end_time": "2025-11-24T19:46:12.690512",
     "exception": false,
     "start_time": "2025-11-24T19:46:12.672968",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "from google.adk.agents import Agent\n",
    "from google.genai import types\n",
    "from google.adk.tools.agent_tool import AgentTool\n",
    "\n",
    "root_agent = Agent(\n",
    "   model='gemini-2.5-flash',\n",
    "   name='root_agent',\n",
    "   description=\"\"\"As a medical pre-authorization agent, you process user \n",
    "   pre-auth request for a treatment.\"\"\",\n",
    "\n",
    "   instruction= \"\"\"\n",
    "    As a medical pre-authorization agent, you process user pre-auth request for\n",
    "    a treatment. \n",
    "\n",
    "    Here's a breakdown of your responsibilities:\n",
    "    1. You will extract relevant insurance details and medical details from \n",
    "    respective documents, specifically for the treatment user is seeking \n",
    "    pre-authorization for.\n",
    "    2. You will analyze the necessity of the treatment based on the extracted \n",
    "    information, then verify user eligibility and coverage under their insurance \n",
    "    plan.\n",
    "    3. Finally, you will create a report detailing the decision to accept or \n",
    "    reject your pre-authorization request.\n",
    "\n",
    "    Here's how you should operate:\n",
    "    1. Start by greeting the user and asking how I can help, providing a quick \n",
    "    overview of what you do.\n",
    "    2. If the request isn't clear, you will ask some questions to understand \n",
    "    user needs better.\n",
    "    3. You will need treatment name and two documents from the user to process \n",
    "    the pre-authorization request: one for their medical records related to the \n",
    "    treatment, and one for their health insurance policy. If these are not \n",
    "    promptly provided, you will explicitly ask the user to provide them, \n",
    "    clarifying which document is which. \n",
    "    4. Extract the treatment name that user is seeking pre-authorisation for \n",
    "    from the user's request using corresponding subagent.\n",
    "    5. Extract medical details and insurance policy details correspondidng to \n",
    "    the treatment name from the documents provided by the user using \n",
    "    corresponding subagent.\n",
    "    6. Next you will require to analyse the extracted content of the documents\n",
    "    and provide a report detailing your decision on pre authorisation request. \n",
    "    You will call the corresponding subagent for this task.\n",
    "    7. Based on the user's intent, determine which sub-agent is best suited to \n",
    "    handle the request.\n",
    "\n",
    "    Ensure all state keys are correctly used to pass information between \n",
    "    subagents. \n",
    "\n",
    "    ***************************************************************************\n",
    "    - Invoke the information_extractor subagent to extract treatment name from \n",
    "    user's request, also to extract details on user's medical records and \n",
    "    insurance coverage for this treatment. The information_extractor subagent \n",
    "    MUST return a comprehensive medical and insurance policy data extracted for \n",
    "    the specified pre auth request.\n",
    "    - Invoke the data_analyst subagent to analyse data provided by information_extractor\n",
    "    subagent and create a report detailing your decision on user's pre-authorization\n",
    "    request for the treatment. The data_analyst_agent MUST have decision on \n",
    "    passing or rejecting the pre-auth request, create a report and store it in \n",
    "    designated path. Invoke the data_analyst subagent only after information_extractor\n",
    "    has completed all its tasks.\n",
    "    **********************************************************************************\n",
    "    **********************************************************************************\n",
    "    \"\"\",\n",
    "\n",
    "   generate_content_config=types.GenerateContentConfig(temperature=0.2),\n",
    "\n",
    "   tools=[\n",
    "        AgentTool(agent=information_extractor),\n",
    "        AgentTool(agent=data_analyst)\n",
    "    ],\n",
    ")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 29,
   "id": "96a979b4",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:12.708250Z",
     "iopub.status.busy": "2025-11-24T19:46:12.707864Z",
     "iopub.status.idle": "2025-11-24T19:46:12.713645Z",
     "shell.execute_reply": "2025-11-24T19:46:12.712682Z"
    },
    "papermill": {
     "duration": 0.016531,
     "end_time": "2025-11-24T19:46:12.715246",
     "exception": false,
     "start_time": "2025-11-24T19:46:12.698715",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "‚úÖ Runner created.\n"
     ]
    }
   ],
   "source": [
    "runner = InMemoryRunner(agent=root_agent)\n",
    "print(\"‚úÖ Runner created.\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 30,
   "id": "95100b99",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:12.732346Z",
     "iopub.status.busy": "2025-11-24T19:46:12.732069Z",
     "iopub.status.idle": "2025-11-24T19:46:14.778547Z",
     "shell.execute_reply": "2025-11-24T19:46:14.777574Z"
    },
    "papermill": {
     "duration": 2.056806,
     "end_time": "2025-11-24T19:46:14.779820",
     "exception": false,
     "start_time": "2025-11-24T19:46:12.723014",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      " ### Created new session: debug_session_id\n",
      "\n",
      "User > Visual Acuity\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "WARNING:google_genai.types:Warning: there are non-text parts in the response: ['thought_signature'], returning concatenated text result from text parts. Check the full candidates.content.parts accessor to get the full model response.\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "root_agent > Hello! I'm a medical pre-authorization agent. I can help you process your pre-authorization request for medical treatments. To do this, I need two documents from you:\n",
      "\n",
      "1.  Your medical records related to the treatment (Visual Acuity).\n",
      "2.  Your health insurance policy document.\n",
      "\n",
      "Could you please provide these documents?\n"
     ]
    }
   ],
   "source": [
    "\n",
    "response = await runner.run_debug('Visual Acuity') "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 31,
   "id": "9d04c9a3",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:14.797812Z",
     "iopub.status.busy": "2025-11-24T19:46:14.797544Z",
     "iopub.status.idle": "2025-11-24T19:46:15.843896Z",
     "shell.execute_reply": "2025-11-24T19:46:15.842828Z"
    },
    "papermill": {
     "duration": 1.058192,
     "end_time": "2025-11-24T19:46:15.845235",
     "exception": false,
     "start_time": "2025-11-24T19:46:14.787043",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      " ### Continue session: debug_session_id\n",
      "\n",
      "User > \n",
      "    HEALTH INSURANCE POLICY CERTIFICATE\n",
      "    Issued by: GreenLife Health Insurance Ltd.\n",
      "\n",
      "    Policy Number: GLH-2025-BD-4421\n",
      "    Issue Date: 12-January-2025\n",
      "    Policy Period: 12-January-2025 to 11-January-2026\n",
      "    Type of Plan: Individual Health Secure\n",
      "    Sum Insured: ‡ß≥7,00,000 (Seven Lakh Taka Only)\n",
      "\n",
      "    Primary Policyholder Information:\n",
      "    ‚Ä¢ Name: Mr. Tanvir Ahmed\n",
      "    ‚Ä¢ Date of Birth: 18-February-1990\n",
      "    ‚Ä¢ Relationship: Self\n",
      "    ‚Ä¢ Address: House 19, Road 5, Sector 10, Uttara, Dhaka-1230\n",
      "    ‚Ä¢ Contact Number: +880-1712-556677\n",
      "    ‚Ä¢ Email: tanvir.ahmed@example.com\n",
      "\n",
      "    Premium Details:\n",
      "    ‚Ä¢ Annual Premium: ‡ß≥12,500\n",
      "    ‚Ä¢ VAT (15%): ‡ß≥1,875\n",
      "    ‚Ä¢ Total Premium Paid: ‡ß≥14,375\n",
      "\n",
      "    Declared Health Conditions at Policy Inception:\n",
      "    ‚Ä¢ Mild gastritis\n",
      "    ‚Ä¢ Occasional migraine headaches\n",
      "    \n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "WARNING:google_genai.types:Warning: there are non-text parts in the response: ['thought_signature'], returning concatenated text result from text parts. Check the full candidates.content.parts accessor to get the full model response.\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "root_agent > Thank you for providing your health insurance policy certificate. I have the insurance details now.\n",
      "\n",
      "To proceed with your pre-authorization request for Visual Acuity, I still need your medical records related to this treatment. Please provide them so I can analyze the necessity of the treatment and verify your eligibility.\n"
     ]
    }
   ],
   "source": [
    "response = await runner.run_debug(\"\"\"\n",
    "    HEALTH INSURANCE POLICY CERTIFICATE\n",
    "    Issued by: GreenLife Health Insurance Ltd.\n",
    "\n",
    "    Policy Number: GLH-2025-BD-4421\n",
    "    Issue Date: 12-January-2025\n",
    "    Policy Period: 12-January-2025 to 11-January-2026\n",
    "    Type of Plan: Individual Health Secure\n",
    "    Sum Insured: ‡ß≥7,00,000 (Seven Lakh Taka Only)\n",
    "\n",
    "    Primary Policyholder Information:\n",
    "    ‚Ä¢ Name: Mr. Tanvir Ahmed\n",
    "    ‚Ä¢ Date of Birth: 18-February-1990\n",
    "    ‚Ä¢ Relationship: Self\n",
    "    ‚Ä¢ Address: House 19, Road 5, Sector 10, Uttara, Dhaka-1230\n",
    "    ‚Ä¢ Contact Number: +880-1712-556677\n",
    "    ‚Ä¢ Email: tanvir.ahmed@example.com\n",
    "\n",
    "    Premium Details:\n",
    "    ‚Ä¢ Annual Premium: ‡ß≥12,500\n",
    "    ‚Ä¢ VAT (15%): ‡ß≥1,875\n",
    "    ‚Ä¢ Total Premium Paid: ‡ß≥14,375\n",
    "\n",
    "    Declared Health Conditions at Policy Inception:\n",
    "    ‚Ä¢ Mild gastritis\n",
    "    ‚Ä¢ Occasional migraine headaches\n",
    "    \"\"\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 32,
   "id": "3476ca7e",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:15.863392Z",
     "iopub.status.busy": "2025-11-24T19:46:15.863093Z",
     "iopub.status.idle": "2025-11-24T19:46:15.868051Z",
     "shell.execute_reply": "2025-11-24T19:46:15.867336Z"
    },
    "papermill": {
     "duration": 0.015869,
     "end_time": "2025-11-24T19:46:15.869471",
     "exception": false,
     "start_time": "2025-11-24T19:46:15.853602",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "medical_agent = LlmAgent(\n",
    "    name=\"medical_agent\",\n",
    "    model=Gemini(model=\"gemini-2.5-flash-lite\", retry_options=retry_config),\n",
    "    # Updated instruction\n",
    "    instruction=\"\"\"You are a smart doctor booking and medicine order assistant and also medical pre-authorization agent, you process user pre-auth request for\n",
    "    a treatment. You must strictly follow these steps and use the available tools.\n",
    "\n",
    "  For any doctor booking or medicine order conversion request:\n",
    "\n",
    "   1. for doctor booking: Use the book_doctor_appointment() tool to book the doctor for patient or use medical_booking_order_agent.\n",
    "   2. for medicine order : Use the book_medicine_online() tool or medical_booking_order_agent   confirm the order.\n",
    "   3. for medical pre-authorization agent : use agent root_agent \n",
    "   4. Error Check: After each tool call, you must check the \"status\" field in the response. If the status is \"error\", you must stop and clearly explain the issue to the user.\n",
    "   5. Provide Detailed Breakdown: In your summary, you must:\n",
    "       * State the final result in json formet.\n",
    "       * Explain how the result was how it work, including:\n",
    "           * The fee percentage and the fee amount \n",
    "    \"\"\",\n",
    "    tools=[AgentTool(agent=root_agent),\n",
    "        AgentTool(agent=medical_booking_order_agent),  # Using another agent as a tool!\n",
    "    ],\n",
    ")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 33,
   "id": "16745543",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:15.887879Z",
     "iopub.status.busy": "2025-11-24T19:46:15.887470Z",
     "iopub.status.idle": "2025-11-24T19:46:16.992585Z",
     "shell.execute_reply": "2025-11-24T19:46:16.991678Z"
    },
    "papermill": {
     "duration": 1.116185,
     "end_time": "2025-11-24T19:46:16.994068",
     "exception": false,
     "start_time": "2025-11-24T19:46:15.877883",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "‚úÖ Runner created.\n",
      "\n",
      " ### Created new session: debug_session_id\n",
      "\n",
      "User > What type of agent you use? and what type of work you can do\n",
      "medical_agent > I am a smart doctor booking and medicine order assistant and also a medical pre-authorization agent. I can help you with:\n",
      "\n",
      "1. **Doctor Booking:** Booking appointments with doctors.\n",
      "2. **Medicine Orders:** Ordering medicines online.\n",
      "3. **Medical Pre-authorization:** Processing pre-authorization requests for treatments.\n",
      "\n",
      "I utilize `medical_booking_order_agent` for booking and ordering, and `root_agent` for pre-authorization requests.\n"
     ]
    }
   ],
   "source": [
    "runner = InMemoryRunner(agent=medical_agent)\n",
    "print(\"‚úÖ Runner created.\")\n",
    "response = await runner.run_debug('What type of agent you use? and what type of work you can do') "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 34,
   "id": "bfaca105",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-24T19:46:17.013053Z",
     "iopub.status.busy": "2025-11-24T19:46:17.012258Z",
     "iopub.status.idle": "2025-11-24T19:46:18.028178Z",
     "shell.execute_reply": "2025-11-24T19:46:18.027111Z"
    },
    "papermill": {
     "duration": 1.026584,
     "end_time": "2025-11-24T19:46:18.029469",
     "exception": false,
     "start_time": "2025-11-24T19:46:17.002885",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      " ### Continue session: debug_session_id\n",
      "\n",
      "User > what is medical pre_authorization\n",
      "medical_agent > Medical pre-authorization, also known as pre-approval or prior authorization, is a process where your health insurance company's approval is required *before* you receive certain medical services or prescription drugs.\n",
      "\n",
      "The purpose of pre-authorization is to ensure that the proposed treatment or medication is:\n",
      "\n",
      "*   **Medically necessary:** It's a required service for your condition.\n",
      "*   **Appropriate:** It's the right treatment for your diagnosis.\n",
      "*   **Cost-effective:** It's a reasonable and covered service under your plan.\n",
      "\n",
      "If you need to get pre-authorization for a treatment, I can help you with that using the `root_agent`.\n"
     ]
    }
   ],
   "source": [
    "response = await runner.run_debug(\"what is medical pre_authorization\")"
   ]
  }
 ],
 "metadata": {
  "kaggle": {
   "accelerator": "none",
   "dataSources": [],
   "dockerImageVersionId": 31192,
   "isGpuEnabled": false,
   "isInternetEnabled": true,
   "language": "python",
   "sourceType": "notebook"
  },
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.13"
  },
  "papermill": {
   "default_parameters": {},
   "duration": 82.973019,
   "end_time": "2025-11-24T19:46:20.890416",
   "environment_variables": {},
   "exception": null,
   "input_path": "__notebook__.ipynb",
   "output_path": "__notebook__.ipynb",
   "parameters": {},
   "start_time": "2025-11-24T19:44:57.917397",
   "version": "2.6.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
